name: Check Fork Sync Status

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-sync:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Count commits behind
        id: count
        run: |
          BEHIND=$(git rev-list --count HEAD..origin/${{ github.base_ref }})
          echo "commits_behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "Commits behind: $BEHIND"

      - name: Comment if fork is outdated
        if: steps.count.outputs.commits_behind > 5
        uses: actions/github-script@v7
        with:
          script: |
            const commitsBehind = '${{ steps.count.outputs.commits_behind }}';
            const message = `‚ö†Ô∏è **Fork Desactualizado Detectado**

Hola @${{ github.event.pull_request.user.login }},

Tu fork est√° **${commitsBehind} commits** atr√°s del repositorio original.

**Por favor, sincroniza tu fork ANTES de continuar:**

### üìñ Gu√≠a R√°pida de Sincronizaci√≥n

**Opci√≥n 1: Desde GitHub Web (F√°cil)**
1. Ve a tu fork: \`${{ github.event.pull_request.head.repo.full_name }}\`
2. Haz clic en "Sync fork" ‚Üí "Update branch"
3. Vuelve a tu rama local: \`git pull origin ${{ github.event.pull_request.head.ref }}\`

**Opci√≥n 2: Desde Terminal (Completo)**
\`\`\`bash
# A√±adir upstream si no lo tienes
git remote add upstream https://github.com/${{ github.repository }}.git

# Sincronizar
git fetch upstream
git checkout main
git merge upstream/main
git push origin main

# Actualizar tu rama
git checkout ${{ github.event.pull_request.head.ref }}
git merge main
git push origin ${{ github.event.pull_request.head.ref }}
\`\`\`

### üìö Documentaci√≥n Completa
üëâ [Gu√≠a de Sincronizaci√≥n de Forks](https://todoeconometria.github.io/ejercicios-bigdata/git-github/sincronizar-fork/)

---

**¬øPor qu√© es importante?**
Mientras no sincronices, este PR muestra commits que NO son tuyos, haciendo dif√≠cil revisar tu trabajo real.

---
ü§ñ *Mensaje autom√°tico - Bot de Validaci√≥n*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Add label if outdated
        if: steps.count.outputs.commits_behind > 5
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['‚ö†Ô∏è fork-desactualizado']
            });
